!function(c){"use strict";var _x=wp.i18n._x;c(document).ready(function(){c("#issue_id").on("keypress",function(e){13===e.which&&(e.preventDefault(),c("#retrieve_mappings").click())}),c("#retrieve_mappings").click(function(){var e=c("#campaign_id").val(),a=c("#issue_id").val(),t=c(this),n=t.text();t.text(""),t.append('<span class="fa fa-spinner fa-spin"></span>'),c.ajax({type:"post",dataType:"json",url:integration_center_obj.ajax_url,data:{action:"appq_get_issue_from_bugtracker",issue_id:a,cp_id:e},success:function(e){if(t.text(n),e.success){var a=e.data.fields;if(c("#retrieved_mappings").find("li").remove(),c("#get_from_bug").find("pre").remove(),c("#get_from_bug").find("h5").remove(),a){var i={};a.reporter&&a.reporter.accountId&&(i.reporter={data:{id:a.reporter.accountId}}),a.assignee&&a.assignee.accountId&&(i.assignee={data:{id:a.assignee.accountId}}),a.issuetype&&a.issuetype.name&&(i.issuetype={data:{name:a.issuetype.name}}),a.labels&&(i.labels={data:a.labels}),c("#get_from_bug").find(".search-bug").hide(),c("<h5>Identified fields</h5>").insertBefore("#retrieved_mappings"),Object.keys(i).forEach(function(e){var a='<li class="row mt-3"><div class="col-9"><small class="name">'+e+'</small><span class="data">'+JSON.stringify(i[e].data)+'</span></div><div class="col-3 text-right"><button class="btn btn-secondary import-mapping">Import</button></div></li>',t=c(a);t.find(".import-mapping").click(function(e){e.preventDefault();var a=c(this).html();c(this).html('<i class="fa fa-spinner fa-spin"></i>');var t=c(this).closest(".row").find(".name").text(),i=c(this).closest(".row").find(".data").text(),n=c("#jira_mapping_field"),r=n.find('input[name="name"]'),s=n.find('textarea[name="value"]'),o=n.find('input[name="sanitize"]'),l=n.find('input[name="is_json"]');r.val(t),s.val(i),"assignee"!==t?o.prop("checked",!0):o.prop("checked",!1),l.prop("checked",!0),n.trigger("submit"),c(this).html(a)}),c("#retrieved_mappings").append(t)}),c('<h5 class="mt-3" >Raw code</h5><pre class="raw-content">'+JSON.stringify(a,void 0,2)+"</pre>").insertAfter("#retrieved_mappings")}else toastr.error(_x("Invalid bug. No fields to retrieve","Integration Center Jira get issue from bugtracker","appq-integration-center-jira-addon"))}else toastr.error(e.data)}})}),c("#jira_fields_settings .field_mapping .remove").click(function(){c(this).parent().remove()}),c("#jira_fields_settings .add_field_mapping").click(function(){var n=c(this);n.attr("disabled","disabled");var e=c('<div style="display:flex"><input type="text" placeholder="key" name="key"><textarea style="flex-grow:1" placeholder="value" name="value"></textarea><button class="btn btn-primary confirm-add-mapping">OK</button></div>');e.find("button").click(function(e){e.preventDefault();var a=c(this).parent().find('[name="key"]').val(),t=c(this).parent().find('[name="value"]').val(),i=c('<div class="form-group row"><label for="key" class="col-sm-2 align-self-center text-center"></label><textarea name="key" class="col-sm-7 form-control" placeholder="Title: {Bug.title}"></textarea><div class="custom-control custom-checkbox col-sm-1"><input name="sanitize" class="custom-control-input" type="checkbox" ><label class="custom-control-label" for="sanitize">Sanitize?</label></div><div class="custom-control custom-checkbox col-sm-1"><input name="is_json" class="custom-control-input" type="checkbox"><label class="custom-control-label" for="is_json">JSON?</label></div><button class="col-sm-1 remove btn btn-danger">-</button></div>');i.find("label[for=key]").attr("for","field_mapping["+a+"]").text(a),i.find("textarea[name=key]").attr("name","field_mapping["+a+"][value]").val(t),i.find(".form-check-input[name=sanitize]").attr("name","field_mapping["+a+"][sanitize]"),i.find("label[for=sanitize]").attr("for","field_mapping["+a+"][sanitize]"),i.find(".form-check-input[name=is_json]").attr("name","field_mapping["+a+"][is_json]"),i.find("label[for=is_json]").attr("for","field_mapping["+a+"][is_json]"),i.find("input[name=is_json]").attr("name","field_mapping["+a+"][is_json]"),i.find(".custom-checkbox").click(function(){var e=c(this).find("input");e.prop("checked",!e.prop("checked"))}),i.find(".remove").click(function(){c(this).parent().remove()}),i.insertBefore(n),c(this).parent().remove(),n.removeAttr("disabled")}),e.insertBefore(c(this))}),c("#jira_tracker_settings").submit(function(e){e.preventDefault();var a=c("#campaign_id").val(),t=c("#jira_tracker_settings").serializeArray();t.push({name:"action",value:"appq_jira_edit_settings"}),t.push({name:"cp_id",value:a}),t.push({name:"nonce",value:integration_center_obj.nonce}),jQuery.ajax({type:"post",dataType:"json",url:integration_center_obj.ajax_url,data:t,success:function(e){toastr.success(_x("Tracker settings updated!","Integration Center Jira edit tracker settings","appq-integration-center-jira-addon")),location.reload()},error:function(e){console.log(e)}})}),console.log(">>>> test localize"),console.log(integration_center_obj),console.log(">>>> test localize"),c("#jira_mapping_field").on("submit",function(e){e.preventDefault();var t=c(".fields-list"),a=c("#campaign_id").val(),i=c("#jira_mapping_field").serializeArray(),n=c(this).find('[type="submit"]'),r=n.html();n.html('<i class="fa fa-spinner fa-spin"></i>'),i.push({name:"action",value:"appq_jira_edit_mapping_fields"}),i.push({name:"cp_id",value:a}),i.push({name:"nonce",value:integration_center_obj.nonce}),console.log("Submit..."),console.log(integration_center_obj.ajax_url),jQuery.ajax({type:"post",dataType:"json",url:integration_center_obj.ajax_url,data:i,success:function(e){toastr.success(_x("Field added!","Integration Center Jira add mapping field","appq-integration-center-jira-addon")),n.html(r);var a=wp.template("field_mapping_row")(e.data);c('[data-row="'+e.data.key+'"]').length?c('[data-row="'+e.data.key+'"]').replaceWith(a):t.prepend(a),c("#add_mapping_field_modal").modal("hide")}})}),c(document).on("click",'[data-target="#add_mapping_field_modal"]',function(){var e=c(this).attr("data-target"),a=c(e).find('input[name="name"]'),t=c(e).find('textarea[name="value"]'),i=c(e).find('input[name="sanitize"]'),n=c(e).find('input[name="is_json"]');a.val(""),t.val(""),i.prop("checked",!1),n.prop("checked",!1);var r=c(this).attr("data-key");if(r){var s=c(this).attr("data-content"),o=c(this).attr("data-sanitize"),l=c(this).attr("data-json");a.val(r),t.val(s),"on"==o&&i.prop("checked",!0),"on"==l&&n.prop("checked",!0)}}),c(document).on("click","#jira_fields_settings .delete-mapping-field",function(){var e=c(this).attr("data-key"),a=c(this).attr("data-target");c(a).find('input[name="field_key"]').val(e)}),c("#jira_delete_field").submit(function(e){e.preventDefault();var a=c(".fields-list"),t=c("#campaign_id").val(),i=c("#jira_delete_field").serializeArray(),n=c(this).find('[type="submit"]'),r=n.html();n.html('<i class="fa fa-spinner fa-spin"></i>'),i.push({name:"action",value:"appq_jira_delete_mapping_fields"}),i.push({name:"cp_id",value:t}),i.push({name:"nonce",value:integration_center_obj.nonce}),jQuery.ajax({type:"post",dataType:"json",url:integration_center_obj.ajax_url,data:i,success:function(e){toastr.success(_x("Field deleted!","Integration Center Jira delete mapping field","appq-integration-center-jira-addon")),n.html(r),a.find('[data-row="'+e.data+'"]').remove(),c("#delete_mapping_field_modal").modal("toggle")}})}),c("#get_from_bug").on("hidden.bs.modal",function(e){c("#get_from_bug").find(".search-bug").show(),c("#retrieved_mappings").find("li").remove(),c("#get_from_bug").find("pre").remove(),c("#get_from_bug").find("h5").remove()}),c(".custom-checkbox").click(function(){var e=c(this).find("input");e.prop("checked",!e.prop("checked"))})})}(jQuery);