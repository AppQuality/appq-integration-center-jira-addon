!function(l){"use strict";var _x=wp.i18n._x;l(document).ready(function(){l("#issue_id").on("keypress",function(e){13===e.which&&(e.preventDefault(),l("#retrieve_mappings").click())}),l("#retrieve_mappings").click(function(){var e=l("#campaign_id").val(),a=l("#issue_id").val(),t=l(this),n=t.text();t.text(""),t.append('<span class="fa fa-spinner fa-spin"></span>'),l.ajax({type:"post",dataType:"json",url:custom_object.ajax_url,data:{action:"appq_get_issue_from_bugtracker",issue_id:a,cp_id:e},success:function(e){if(t.text(n),e.success){var a=e.data.fields;if(l("#retrieved_mappings").find("li").remove(),l("#get_from_bug").find("pre").remove(),l("#get_from_bug").find("h5").remove(),a){var i={};a.reporter&&a.reporter.accountId&&(i.reporter={data:{id:a.reporter.accountId}}),a.assignee&&a.assignee.accountId&&(i.assignee={data:{id:a.assignee.accountId}}),a.issuetype&&a.issuetype.name&&(i.issuetype={data:{name:a.issuetype.name}}),a.labels&&(i.labels={data:a.labels}),l("#get_from_bug").find(".search-bug").hide(),l("<h5>Identified fields</h5>").insertBefore("#retrieved_mappings"),Object.keys(i).forEach(function(e){var a='<li class="row mt-3"><div class="col-9"><small class="name">'+e+'</small><span class="data">'+JSON.stringify(i[e].data)+'</span></div><div class="col-3 text-right"><button class="btn btn-secondary import-mapping">Import</button></div></li>',t=l(a);t.find(".import-mapping").click(function(e){e.preventDefault();var a=l(this).html();l(this).html('<i class="fa fa-spinner fa-spin"></i>');var t=l(this).closest(".row").find(".name").text(),i=l(this).closest(".row").find(".data").text(),n=l("#jira_mapping_field"),s=n.find('input[name="name"]'),r=n.find('textarea[name="value"]'),o=n.find('input[name="sanitize"]'),p=n.find('input[name="is_json"]');s.val(t),r.val(i),"assignee"!==t?o.prop("checked",!0):o.prop("checked",!1),p.prop("checked",!0),n.trigger("submit"),l(this).html(a)}),l("#retrieved_mappings").append(t)}),l('<h5 class="mt-3" >Raw code</h5><pre class="raw-content">'+JSON.stringify(a,void 0,2)+"</pre>").insertAfter("#retrieved_mappings")}else toastr.error(_x("Invalid bug. No fields to retrieve","Integration Center Jira get issue from bugtracker","appq-integration-center-jira-addon"))}else toastr.error(e.data)}})}),l("#jira_fields_settings .field_mapping .remove").click(function(){l(this).parent().remove()}),l("#jira_fields_settings .add_field_mapping").click(function(){var n=l(this);n.attr("disabled","disabled");var e=l('<div style="display:flex"><input type="text" placeholder="key" name="key"><textarea style="flex-grow:1" placeholder="value" name="value"></textarea><button class="btn btn-primary confirm-add-mapping">OK</button></div>');e.find("button").click(function(e){e.preventDefault();var a=l(this).parent().find('[name="key"]').val(),t=l(this).parent().find('[name="value"]').val(),i=l('<div class="form-group row"><label for="key" class="col-sm-2 align-self-center text-center"></label><textarea name="key" class="col-sm-7 form-control" placeholder="Title: {Bug.title}"></textarea><div class="custom-control custom-checkbox col-sm-1"><input name="sanitize" class="custom-control-input" type="checkbox" ><label class="custom-control-label" for="sanitize">Sanitize?</label></div><div class="custom-control custom-checkbox col-sm-1"><input name="is_json" class="custom-control-input" type="checkbox"><label class="custom-control-label" for="is_json">JSON?</label></div><button class="col-sm-1 remove btn btn-danger">-</button></div>');i.find("label[for=key]").attr("for","field_mapping["+a+"]").text(a),i.find("textarea[name=key]").attr("name","field_mapping["+a+"][value]").val(t),i.find(".form-check-input[name=sanitize]").attr("name","field_mapping["+a+"][sanitize]"),i.find("label[for=sanitize]").attr("for","field_mapping["+a+"][sanitize]"),i.find(".form-check-input[name=is_json]").attr("name","field_mapping["+a+"][is_json]"),i.find("label[for=is_json]").attr("for","field_mapping["+a+"][is_json]"),i.find("input[name=is_json]").attr("name","field_mapping["+a+"][is_json]"),i.find(".custom-checkbox").click(function(){var e=l(this).find("input");e.prop("checked",!e.prop("checked"))}),i.find(".remove").click(function(){l(this).parent().remove()}),i.insertBefore(n),l(this).parent().remove(),n.removeAttr("disabled")}),e.insertBefore(l(this))}),l("#jira_tracker_settings").submit(function(e){e.preventDefault();var a=l("#campaign_id").val(),t=l("#jira_tracker_settings").serializeArray();t.push({name:"action",value:"appq_jira_edit_settings"}),t.push({name:"cp_id",value:a}),t.push({name:"nonce",value:appq_ajax.nonce}),jQuery.ajax({type:"post",dataType:"json",url:appq_ajax.url,data:t,success:function(e){toastr.success(_x("Tracker settings updated!","Integration Center Jira edit tracker settings","appq-integration-center-jira-addon")),location.reload()}})}),l("#jira_mapping_field").submit(function(e){e.preventDefault();var t=l(".fields-list"),a=l("#campaign_id").val(),i=l("#jira_mapping_field").serializeArray(),n=l(this).find('[type="submit"]'),s=n.html();n.html('<i class="fa fa-spinner fa-spin"></i>'),i.push({name:"action",value:"appq_jira_edit_mapping_fields"}),i.push({name:"cp_id",value:a}),i.push({name:"nonce",value:appq_ajax.nonce}),jQuery.ajax({type:"post",dataType:"json",url:appq_ajax.url,data:i,success:function(e){toastr.success(_x("Field added!","Integration Center Jira add mapping field","appq-integration-center-jira-addon")),n.html(s);var a=wp.template("field_mapping_row")(e.data);l('[data-row="'+e.data.key+'"]').length?l('[data-row="'+e.data.key+'"]').replaceWith(a):t.prepend(a),l("#add_mapping_field_modal").modal("hide")}})}),l(document).on("click",'[data-target="#add_mapping_field_modal"]',function(){var e=l(this).attr("data-target"),a=l(e).find('input[name="name"]'),t=l(e).find('textarea[name="value"]'),i=l(e).find('input[name="sanitize"]'),n=l(e).find('input[name="is_json"]');a.val(""),t.val(""),i.prop("checked",!1),n.prop("checked",!1);var s=l(this).attr("data-key");if(s){var r=l(this).attr("data-content"),o=l(this).attr("data-sanitize"),p=l(this).attr("data-json");a.val(s),t.val(r),"on"==o&&i.prop("checked",!0),"on"==p&&n.prop("checked",!0)}}),l(document).on("click","#jira_fields_settings .delete-mapping-field",function(){var e=l(this).attr("data-key"),a=l(this).attr("data-target");l(a).find('input[name="field_key"]').val(e)}),l("#jira_delete_field").submit(function(e){e.preventDefault();var a=l(".fields-list"),t=l("#campaign_id").val(),i=l("#jira_delete_field").serializeArray(),n=l(this).find('[type="submit"]'),s=n.html();n.html('<i class="fa fa-spinner fa-spin"></i>'),i.push({name:"action",value:"appq_jira_delete_mapping_fields"}),i.push({name:"cp_id",value:t}),i.push({name:"nonce",value:appq_ajax.nonce}),jQuery.ajax({type:"post",dataType:"json",url:appq_ajax.url,data:i,success:function(e){toastr.success(_x("Field deleted!","Integration Center Jira delete mapping field","appq-integration-center-jira-addon")),n.html(s),a.find('[data-row="'+e.data+'"]').remove(),l("#delete_mapping_field_modal").modal("toggle")}})}),l("#get_from_bug").on("hidden.bs.modal",function(e){l("#get_from_bug").find(".search-bug").show(),l("#retrieved_mappings").find("li").remove(),l("#get_from_bug").find("pre").remove(),l("#get_from_bug").find("h5").remove()}),l(".custom-checkbox").click(function(){var e=l(this).find("input");e.prop("checked",!e.prop("checked"))})})}(jQuery);