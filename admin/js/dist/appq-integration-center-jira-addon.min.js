!function(d){"use strict";var _x=wp.i18n._x;d(document).ready(function(){d("#issue_id").on("keypress",function(e){13===e.which&&(e.preventDefault(),d("#retrieve_mappings").click())}),d("#retrieve_mappings").click(function(){var e=d("#campaign_id").val(),a=d("#issue_id").val(),t=d(this),n=t.text();t.addClass("disabled"),t.text(""),t.append('<i class="fa fa-spinner fa-spin"></i>'),d.ajax({type:"post",dataType:"json",url:integration_center_obj.ajax_url,data:{action:"appq_get_issue_from_bugtracker",issue_id:a,cp_id:e},success:function(e){if(e.success){var a=e.data.fields;if(d("#retrieved_mappings").find("li").remove(),d("#get_from_bug").find("pre").remove(),d("#get_from_bug").find("h5").remove(),a){var i={};a.reporter&&a.reporter.accountId&&(i.reporter={data:{id:a.reporter.accountId}}),a.assignee&&a.assignee.accountId&&(i.assignee={data:{id:a.assignee.accountId}}),a.issuetype&&a.issuetype.name&&(i.issuetype={data:{name:a.issuetype.name}}),a.labels&&(i.labels={data:a.labels}),d("#get_from_bug").find(".search-bug").hide(),d("<h4 class='text-primary'>"+_x("Identified fields","inspected bug","appq-integration-center-jira-addon")+"</h4>").insertBefore("#retrieved_mappings"),Object.keys(i).forEach(function(e){var a='<li class="tile"><a class="tile-content"><div class="tile-text"><small class="name">'+e+'</small><span class="data">'+JSON.stringify(i[e].data)+'</span></div></a><a class="btn btn-flat import-mapping">'+_x("Add Mapping","add mapping from inspected bug","appq-integration-center-jira-addon")+"</a></li>",t=d(a);t.find(".import-mapping").click(function(e){e.preventDefault();var a=d(this).html();d(this).html('<i class="fa fa-spinner fa-spin"></i>');var t=d(this).closest(".row").find(".name").text(),i=d(this).closest(".row").find(".data").text(),n=d("#jira_mapping_field"),r=n.find('input[name="name"]'),s=n.find('textarea[name="value"]'),o=n.find('input[name="sanitize"]'),l=n.find('input[name="is_json"]');r.val(t),s.val(i),"assignee"!==t?o.prop("checked",!0):o.prop("checked",!1),l.prop("checked",!0),n.trigger("submit"),d(this).html(a)}),d("#retrieved_mappings").append(t)}),d('<h4 class="text-primary">Raw code</h4><div class="scroll height-5"><pre class="raw-content">'+JSON.stringify(a,void 0,2)+"</pre></div>").insertAfter("#retrieved_mappings"),void 0!==typeof crowdappquality&&crowdappquality.AppVendor._initScroller()}else toastr.error(_x("Invalid bug. No fields to retrieve","Integration Center Jira get issue from bugtracker","appq-integration-center-jira-addon"))}else toastr.error(e.data);t.text(n),t.removeClass("disabled")}})}),d("#jira_fields_settings .field_mapping .remove").click(function(){d(this).parent().remove()}),d("#jira_fields_settings .add_field_mapping").click(function(){var n=d(this);n.attr("disabled","disabled");var e=d('<div style="display:flex"><input type="text" placeholder="key" name="key"><textarea style="flex-grow:1" placeholder="value" name="value"></textarea><button class="btn btn-primary confirm-add-mapping">OK</button></div>');e.find("button").click(function(e){e.preventDefault();var a=d(this).parent().find('[name="key"]').val(),t=d(this).parent().find('[name="value"]').val(),i=d('<div class="form-group row"><label for="key" class="col-sm-2 align-self-center text-center"></label><textarea name="key" class="col-sm-7 form-control" placeholder="Title: {Bug.title}"></textarea><div class="custom-control custom-checkbox col-sm-1"><input name="sanitize" class="custom-control-input" type="checkbox" ><label class="custom-control-label" for="sanitize">Sanitize?</label></div><div class="custom-control custom-checkbox col-sm-1"><input name="is_json" class="custom-control-input" type="checkbox"><label class="custom-control-label" for="is_json">JSON?</label></div><button class="col-sm-1 remove btn btn-danger">-</button></div>');i.find("label[for=key]").attr("for","field_mapping["+a+"]").text(a),i.find("textarea[name=key]").attr("name","field_mapping["+a+"][value]").val(t),i.find(".form-check-input[name=sanitize]").attr("name","field_mapping["+a+"][sanitize]"),i.find("label[for=sanitize]").attr("for","field_mapping["+a+"][sanitize]"),i.find(".form-check-input[name=is_json]").attr("name","field_mapping["+a+"][is_json]"),i.find("label[for=is_json]").attr("for","field_mapping["+a+"][is_json]"),i.find("input[name=is_json]").attr("name","field_mapping["+a+"][is_json]"),i.find(".custom-checkbox").click(function(){var e=d(this).find("input");e.prop("checked",!e.prop("checked"))}),i.find(".remove").click(function(){d(this).parent().remove()}),i.insertBefore(n),d(this).parent().remove(),n.removeAttr("disabled")}),e.insertBefore(d(this))}),d("#jira_tracker_settings").submit(function(e){e.preventDefault();var a=d("#campaign_id").val(),t=d("#jira_tracker_settings").serializeArray();t.push({name:"action",value:"appq_jira_edit_settings"}),t.push({name:"cp_id",value:a}),t.push({name:"nonce",value:integration_center_obj.nonce}),jQuery.ajax({type:"post",dataType:"json",url:integration_center_obj.ajax_url,data:t,success:function(e){toastr.success(_x("Tracker settings updated!","Integration Center Jira edit tracker settings","appq-integration-center-jira-addon")),location.reload()},error:function(e){console.log(e)}})}),d("#jira_mapping_field").on("submit",function(e){e.preventDefault();var t=d(".fields-list"),a=d("#campaign_id").val(),i=d("#jira_mapping_field").serializeArray(),n=d(this).find('[type="submit"]'),r=n.html();n.html('<i class="fa fa-spinner fa-spin"></i>'),i.push({name:"action",value:"appq_jira_edit_mapping_fields"}),i.push({name:"cp_id",value:a}),i.push({name:"nonce",value:integration_center_obj.nonce}),console.log("Submit..."),console.log(integration_center_obj.ajax_url),jQuery.ajax({type:"post",dataType:"json",url:integration_center_obj.ajax_url,data:i,success:function(e){toastr.success(_x("Field added!","Integration Center Jira add mapping field","appq-integration-center-jira-addon")),n.html(r);var a=wp.template("field_mapping_row")(e.data);d('[data-row="'+e.data.key+'"]').length?d('[data-row="'+e.data.key+'"]').replaceWith(a):t.prepend(a),d("#add_mapping_field_modal").modal("hide")}})}),d(document).on("click",'[data-target="#add_mapping_field_modal"]',function(){var e=d(this).attr("data-target"),a=d(e).find('input[name="name"]'),t=d(e).find('textarea[name="value"]'),i=d(e).find('input[name="sanitize"]'),n=d(e).find('input[name="is_json"]');a.val(""),t.val(""),i.prop("checked",!1),n.prop("checked",!1);var r=d(this).attr("data-key");if(r){var s=d(this).attr("data-content"),o=d(this).attr("data-sanitize"),l=d(this).attr("data-json");a.val(r),t.val(s),"on"==o&&i.prop("checked",!0),"on"==l&&n.prop("checked",!0)}}),d(document).on("click","#jira_fields_settings .delete-mapping-field",function(){var e=d(this).attr("data-key"),a=d(this).attr("data-target");d(a).find('input[name="field_key"]').val(e)}),d("#jira_delete_field").submit(function(e){e.preventDefault();var a=d(".fields-list"),t=d("#campaign_id").val(),i=d("#jira_delete_field").serializeArray(),n=d(this).find('[type="submit"]'),r=n.html();n.html('<i class="fa fa-spinner fa-spin"></i>'),i.push({name:"action",value:"appq_jira_delete_mapping_fields"}),i.push({name:"cp_id",value:t}),i.push({name:"nonce",value:integration_center_obj.nonce}),jQuery.ajax({type:"post",dataType:"json",url:integration_center_obj.ajax_url,data:i,success:function(e){toastr.success(_x("Field deleted!","Integration Center Jira delete mapping field","appq-integration-center-jira-addon")),n.html(r),a.find('[data-row="'+e.data+'"]').remove(),d("#delete_mapping_field_modal").modal("toggle")}})}),d("#get_from_bug").on("hidden.bs.modal",function(e){d("#get_from_bug").find(".search-bug").show(),d("#retrieved_mappings").find("li").remove(),d("#get_from_bug").find("pre").remove(),d("#get_from_bug").find("h5").remove()}),d(".custom-checkbox").click(function(){var e=d(this).find("input");e.prop("checked",!e.prop("checked"))})})}(jQuery);